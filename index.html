<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- Allow Coinbase Wallet injection (unsafe-eval) -->
  <meta http-equiv="Content-Security-Policy"
        content="script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';">

  <title>Remove Liquidity DApp 13</title>

  <!-- Ethers.js UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 2rem auto; }
    input, button { width: 100%; padding: .5rem; margin: .5rem 0; }
    #status, #txHash { white-space: pre-wrap; margin: .5rem 0; }
    #txHash { word-break: break-all; }
  </style>
</head>
<body>

  <h1>Remove Liquidity 13</h1>

  <button id="connectBtn">Connect Coinbase Wallet</button>
  <div id="status">Wallet not connected</div>

  <label>Amount of LP tokens to remove:</label>
  <input type="text" id="liquidityAmount" placeholder="1.234" />

  <label>Gas Price (gwei):</label>
  <input type="text" id="gasPriceGwei" placeholder="100" />

  <button id="removeBtn" disabled>Remove Liquidity</button>
  <div id="txHash"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const statusElem = document.getElementById('status');
      const connectBtn = document.getElementById('connectBtn');
      const removeBtn  = document.getElementById('removeBtn');
      const txHashElem = document.getElementById('txHash');

      // 1) Robust Coinbase Wallet detection
      function getCoinbaseProvider() {
        if (window.ethereum?.providers) {
          return window.ethereum.providers.find(p => p.isCoinbaseWallet);
        }
        if (window.ethereum?.isCoinbaseWallet) {
          return window.ethereum;
        }
        return null;
      }

      const cbProvider = getCoinbaseProvider();
      if (!cbProvider) {
        statusElem.innerText = '‚ùå Coinbase Wallet extension not found';
        return;
      }
      console.log('‚úÖ Found Coinbase provider', cbProvider);

      // 2) Ethers provider & placeholders
      const provider = new ethers.providers.Web3Provider(cbProvider, 'any');
      let signer, contract;

      // 3) YOUR CONTRACT (replace with yours)
      const CONTRACT_ADDRESS = '0xFf40827Ee1c4Eb6052044101E1C6E28DBe1440e3';
      const CONTRACT_ABI     = [
{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"uint256","name":"eth","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shareprice","type":"uint256"}],"name":"LiquidityAdd","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"uint256","name":"eth","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shares","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"shareprice","type":"uint256"}],"name":"LiquidityRemove","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"bullPrice","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bearPrice","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bullLiqEquity","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bearLiqEquity","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bullEquity","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bearEquity","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"roundId","type":"uint256"},{"indexed":false,"internalType":"bool","name":"updated","type":"bool"}],"name":"PriceUpdate","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokensMinted","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"ethin","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fees","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"bonus","type":"uint256"}],"name":"TokenBuy","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokensBurned","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"ethout","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fees","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"penalty","type":"uint256"}],"name":"TokenSell","type":"event"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"addLiquidity","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"advanceRoundId","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getActive","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBalanceEquity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBearToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBullToken","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getBuyFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getDepositEquity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"getEquity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLatestRoundId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"getLiqEquity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getLiqFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"getLiqTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMultiplier","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"getPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSellFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"getTokenEquity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"getTokenLiqEquity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalEquity","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTotalLiqShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"getUserShares","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"priceAggregator","outputs":[{"internalType":"contract priceAggregatorInterface","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"priceCalculator","outputs":[{"internalType":"contract priceCalculatorInterface","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"shares","type":"uint256"}],"name":"removeLiquidity","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"state","type":"bool"},{"internalType":"uint256","name":"roundId","type":"uint256"}],"name":"setActive","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"setBuyFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"setSellFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"bearAddress","type":"address"},{"internalType":"address","name":"bullAddress","type":"address"}],"name":"setTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"synStakingProxy","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"address","name":"account","type":"address"}],"name":"tokenBuy","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"},{"internalType":"address payable","name":"account","type":"address"}],"name":"tokenSell","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"updatePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"vaultHelper","outputs":[{"internalType":"contract vaultHelperInterface","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}


      ];

      // 4) Connect flow
      connectBtn.addEventListener('click', async () => {
        statusElem.innerText = '‚è≥ Connecting‚Ä¶';
        try {
          await cbProvider.request({ method: 'eth_requestAccounts' });
          signer = provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          const addr = await signer.getAddress();
          statusElem.innerText = '‚úÖ Connected: ' + addr;
          removeBtn.disabled = false;
        } catch (err) {
          console.error('Connection error', err);
          statusElem.innerText = '‚ùå Connect failed: ' + err.message;
        }
      });

      // 5) removeLiquidity flow
removeBtn.addEventListener('click', async () => {
  txHashElem.innerText = '';

  // 1) Read & validate inputs
  const amtInput     = document.getElementById('liquidityAmount').value.trim();
  const tipGweiInput = document.getElementById('gasPriceGwei').value.trim();
  if (!amtInput || isNaN(amtInput) || !tipGweiInput || isNaN(tipGweiInput)) {
    return alert('Enter valid numbers for both fields.');
  }

  // 2) Parse values
  const sharesToRemove    = ethers.utils.parseUnits(amtInput, 18);
  const maxPriorityFeeGas = ethers.utils.parseUnits(tipGweiInput, 'gwei');
  const feeData           = await provider.getFeeData();
  const maxFeePerGas      = feeData.maxFeePerGas.mul(120).div(100); // bump +20%

  // 3) Pre-checks: user shares & pool active
  let userAddr, userShares, isActive;
  try {
    userAddr   = await signer.getAddress();
    userShares = await contract.getUserShares(userAddr);
    isActive   = await contract.getActive();
  } catch (err) {
    console.error('Pre-check failed:', err);
    return alert('Failed to read on-chain state: ' + err.message);
  }

  if (!isActive) {
    return alert('Pool isn‚Äôt active right now. Try again later.');
  }
  if (userShares.lt(sharesToRemove)) {
    return alert(
      `Insufficient shares: you have ${ethers.utils.formatUnits(userShares,18)} but requested ${amtInput}`
    );
  }

  // 4) Try to estimate gas, fallback on unpredictable‚Äêgas errors
  let gasLimit;
  try {
    gasLimit = await contract.estimateGas.removeLiquidity(sharesToRemove);
    console.log('‚úÖ Gas estimate:', gasLimit.toString());
  } catch (err) {
    console.warn('‚ö†Ô∏è Gas estimate failed, falling back to 300 000:', err);
    gasLimit = ethers.BigNumber.from(300000);
  }

  // 5) Optional: check ETH balance for gas
  try {
    const ethBalance = await provider.getBalance(userAddr);
    const needed     = gasLimit.mul(maxFeePerGas);
    if (ethBalance.lt(needed)) {
      return alert(
        `Not enough ETH for gas. You have ${ethers.utils.formatEther(ethBalance)} ETH, need ~${ethers.utils.formatEther(needed)} ETH.`
      );
    }
  } catch (err) {
    console.warn('Could not fetch balance:', err);
  }

  // 6) callStatic to catch any other revert (no reason string if bare revert)
  try {
    await contract.callStatic.removeLiquidity(sharesToRemove, {
      maxPriorityFeePerGas,
      maxFeePerGas,
      gasLimit
    });
  } catch (staticErr) {
    console.error('üö´ Simulation revert:', staticErr);
    return alert(
      'Reverted on static simulation' +
      (staticErr.reason ? ': ' + staticErr.reason : '; no reason returned')
    );
  }

  // 7) Send the real EIP-1559 tx
  try {
    const tx = await contract.removeLiquidity(sharesToRemove, {
      maxPriorityFeePerGas,
      maxFeePerGas,
      gasLimit
    });
    txHashElem.innerHTML =
      `Sent: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash}</a>`;
    await tx.wait();
    txHashElem.innerText += '\n‚úÖ Confirmed!';
  } catch (err) {
    console.error('‚ùå removeLiquidity error:', err);
    txHashElem.innerText = 'Error: ' + (err.error?.message || err.message);
  }
});





    });
  </script>
</body>
</html>
