<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- Allow Coinbase Wallet injection (unsafe-eval) -->
  <meta http-equiv="Content-Security-Policy"
        content="script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';">

  <title>Remove Liquidity DApp 10</title>

  <!-- Ethers.js UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: sans-serif; max-width: 500px; margin: 2rem auto; }
    input, button { width: 100%; padding: .5rem; margin: .5rem 0; }
    #status, #txHash { white-space: pre-wrap; margin: .5rem 0; }
    #txHash { word-break: break-all; }
  </style>
</head>
<body>

  <h1>Remove Liquidity 10</h1>

  <button id="connectBtn">Connect Coinbase Wallet</button>
  <div id="status">Wallet not connected</div>

  <label>Amount of LP tokens to remove:</label>
  <input type="text" id="liquidityAmount" placeholder="1.234" />

  <label>Gas Price (gwei):</label>
  <input type="text" id="gasPriceGwei" placeholder="100" />

  <button id="removeBtn" disabled>Remove Liquidity</button>
  <div id="txHash"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const statusElem = document.getElementById('status');
      const connectBtn = document.getElementById('connectBtn');
      const removeBtn  = document.getElementById('removeBtn');
      const txHashElem = document.getElementById('txHash');

      // 1) Robust Coinbase Wallet detection
      function getCoinbaseProvider() {
        if (window.ethereum?.providers) {
          return window.ethereum.providers.find(p => p.isCoinbaseWallet);
        }
        if (window.ethereum?.isCoinbaseWallet) {
          return window.ethereum;
        }
        return null;
      }

      const cbProvider = getCoinbaseProvider();
      if (!cbProvider) {
        statusElem.innerText = 'âŒ Coinbase Wallet extension not found';
        return;
      }
      console.log('âœ… Found Coinbase provider', cbProvider);

      // 2) Ethers provider & placeholders
      const provider = new ethers.providers.Web3Provider(cbProvider, 'any');
      let signer, contract;

      // 3) YOUR CONTRACT (replace with yours)
      const CONTRACT_ADDRESS = '0xFf40827Ee1c4Eb6052044101E1C6E28DBe1440e3';
      const CONTRACT_ABI     = [
        'function removeLiquidity(uint256 amount) external'
      ];

      // 4) Connect flow
      connectBtn.addEventListener('click', async () => {
        statusElem.innerText = 'â³ Connectingâ€¦';
        try {
          await cbProvider.request({ method: 'eth_requestAccounts' });
          signer = provider.getSigner();
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          const addr = await signer.getAddress();
          statusElem.innerText = 'âœ… Connected: ' + addr;
          removeBtn.disabled = false;
        } catch (err) {
          console.error('Connection error', err);
          statusElem.innerText = 'âŒ Connect failed: ' + err.message;
        }
      });

      // 5) removeLiquidity flow
removeBtn.addEventListener('click', async () => {
  const amt      = ethers.utils.parseUnits(inputAmt, 18);
  const gasPrice = ethers.utils.parseUnits(inputGwei, 'gwei');
  const userAddr = await signer.getAddress();

  // A) Show revert reason before sending
  try {
    await contract.callStatic.removeLiquidity(amt, { gasPrice });
  } catch (err) {
    console.error('ðŸš« Static call revert:', err.reason || err.error?.message);
    return alert('Revert: ' + (err.reason || err.error?.message));
  }

  // B) Check LP balance & allowance
  const lp = new ethers.Contract(LP_TOKEN_ADDRESS, ['function balanceOf(address)view returns(uint256)', 'function allowance(address,address)view returns(uint256)'], signer);
  const bal = await lp.balanceOf(userAddr);
  const allowance = await lp.allowance(userAddr, CONTRACT_ADDRESS);
  if (bal.lt(amt)) {
    return alert('Insufficient LP balance');
  }
  if (allowance.lt(amt)) {
    return alert('Approve LP tokens first');
  }

  // C) Finally send the tx
  const tx = await contract.removeLiquidity(amt, { gasPrice });
  // â€¦
});

    });
  </script>
</body>
</html>
